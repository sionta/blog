{% if page.comments == true and site.comments.provider %}
  {% assign PROVIDER_NAME = site.comments.provider %}
  {% assign PROVIDER_DATA = site.comments[PROVIDER_NAME] %}
  <div
    id="site-comment"
    class="{{ PROVIDER_NAME }}"
    itemscope
    itemtype="https://schema.org/Comment"
    pageurl="{{ page.url | absolute_url }}"
  ></div>
  <script type="text/javascript">
    const themeMode =
      localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    const giscusTheme = themeMode === 'dark' ? 'dark_dimmed' : 'light';

    const giscusAttributes = {
      src: 'https://giscus.app/client.js',
      'data-repo': '{{ PROVIDER_DATA.repo }}',
      'data-repo-id': '{{ PROVIDER_DATA.repo_id }}',
      'data-category': '{{ PROVIDER_DATA.category }}',
      'data-category-id': '{{ PROVIDER_DATA.category_id }}',
      'data-mapping': "{{ PROVIDER_DATA.mapping | default: 'pathname' }}",
      'data-strict': '{{ PROVIDER_DATA.strict | default: 0 }}',
      'data-reactions-enabled': '{{ PROVIDER_DATA.reactions_enabled | default: 1 }}',
      'data-emit-metadata': '{{ PROVIDER_DATA.metadata | default: 0 }}',
      'data-theme': giscusTheme,
      'data-lang': "{{ PROVIDER_DATA.lang | default: site.lang | default: 'en' }}",
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: true,
    };

    const giscusScript = document.createElement('script');
    Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
    document.getElementById('site-comment').appendChild(giscusScript);
  </script>
{% endif %}
